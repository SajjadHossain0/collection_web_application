<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
              crossorigin="anonymous">
        <title>Collection's</title>

</head>
<body>
<section th:fragment="user_info_table">

    <div class="container" style="margin-top: 100px;">
        <div class="toolbar d-flex justify-content-between align-items-center flex-wrap" style="margin-bottom: 10px;">
            <div class="d-flex flex-wrap">
                <ul class="list-unstyled d-flex ">
                    <li>
                        <button id="blockBtn" class="btn" onclick="confirmBlock()" style="margin: 2px; background-color: #d9534f; color: white; border: none;">
                            Block
                        </button>
                    </li>
                    <li>
                        <button id="unblockBtn" class="btn" style="margin: 2px; background-color: #5cb85c; color: white; border: none;">
                            Unblock
                        </button>
                    </li>
                    <li>
                        <button id="deleteBtn" class="btn" onclick="confirmDelete(event)" style="margin: 2px; background-color: #f0ad4e; color: white; border: none;">
                            Delete
                        </button>
                    </li>
                    <li>
                        <button id="makeAdminBtn" class="btn" style="margin: 2px; background-color: #5bc0de; color: white; border: none;">
                            Make as Admin
                        </button>
                    </li>
                    <li>
                        <button id="removeAdminBtn" class="btn" onclick="confirmRemove(event)" style="margin: 2px; background-color: #d9534f; color: white; border: none;">
                            Remove from Admin
                        </button>
                    </li>
                </ul>
            </div>
            <div>
                <form th:action="@{/admin/userDetails/search}" method="get" class="d-flex">
                    <input id="search-input" type="text" name="query" class="form-control" placeholder="Search by email or role" />
                    <div class="search-result"></div>
                </form>
            </div>
        </div>

        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th scope="col">Id</th>
                <th scope="col">Name</th>
                <th scope="col">E-mail</th>
                <th scope="col">Last login time</th>
                <th scope="col">Registration time</th>
                <th scope="col">Active status</th>
                <th scope="col">Role</th>
                <th scope="col">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user,status : ${userDetails}">
                <td><input type="checkbox" class="selectRow"></td>
                <td th:text="${status.index + 1}"></td>
                <td th:text="${user.name}"></td>
                <td th:text="${user.email}"></td>
                <td th:text="${user.lastLoginTime}"></td>
                <td th:text="${user.registrationTime}"></td>
                <td th:text="${user.active ? 'Active' : 'Blocked'}"></td>
                <td th:text="${user.role}" th:style="${user.role == 'ADMIN'} ? 'color: green;' : ''"></td>
                <td><a type="button" href="#" id="viewBtn" class="btn btn-info" style="margin-right: 5px;">view</a></td>
            </tr>
            </tbody>
        </table>
    </div>

    <script>
        document.getElementById('selectAll').onclick = function() {
            var checkboxes = document.querySelectorAll('.selectRow');
            for (var checkbox of checkboxes) {
                checkbox.checked = this.checked;
            }
        }
        document.addEventListener("DOMContentLoaded", function() {
            function getCsrfToken() {
                const tokenMeta = document.querySelector('meta[name="_csrf"]');
                return tokenMeta ? tokenMeta.getAttribute('content') : '';
            }

            function getCsrfHeader() {
                const headerMeta = document.querySelector('meta[name="_csrf_header"]');
                return headerMeta ? headerMeta.getAttribute('content') : '';
            }

            function sendRequest(url, userIds, method) {
                const csrfHeaderName = getCsrfHeader();
                const csrfToken = getCsrfToken();

                if (!csrfHeaderName || !csrfToken) {
                    console.error('CSRF token or header name not found');
                    return;
                }

                const headers = new Headers();
                headers.append('Content-Type', 'application/json');
                headers.append(csrfHeaderName, csrfToken);

                fetch(url, {
                    method: method,
                    headers: headers,
                    body: JSON.stringify(userIds)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(data => {
                        if (data === "LOGOUT") {
                            window.location.href = "/logout";
                        } else {
                            alert(data);
                            location.reload(); // Refresh page to reflect changes
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            function getSelectedUserIds() {
                var checkboxes = document.querySelectorAll('.selectRow:checked');
                var userIds = [];
                for (var checkbox of checkboxes) {
                    var row = checkbox.closest('tr');
                    userIds.push(row.cells[1].innerText.trim()); // Ensure whitespace is trimmed
                }
                return userIds;
            }

            document.getElementById('blockBtn').onclick = function() {
                var userIds = getSelectedUserIds();
                if (userIds.length > 0) {
                    sendRequest('/admin/block', userIds, 'POST');
                } else {
                    alert('No users selected');
                }
            };

            document.getElementById('unblockBtn').onclick = function() {
                var userIds = getSelectedUserIds();
                if (userIds.length > 0) {
                    sendRequest('/admin/unblock', userIds, 'POST');
                } else {
                    alert('No users selected');
                }
            };

            document.getElementById('deleteBtn').onclick = function() {
                var userIds = getSelectedUserIds();
                if (userIds.length > 0) {
                    sendRequest('/admin/delete', userIds, 'POST');
                } else {
                    alert('No users selected');
                }
            };

            document.getElementById('makeAdminBtn').onclick = function() {
                var userIds = getSelectedUserIds();
                if (userIds.length > 0) {
                    sendRequest('/admin/make_admin', userIds, 'POST');
                } else {
                    alert('No users selected');
                }
            };

            document.getElementById('removeAdminBtn').onclick = function() {
                var userIds = getSelectedUserIds();
                if (userIds.length > 0) {
                    sendRequest('/admin/remove_admin', userIds, 'POST');
                } else {
                    alert('No users selected');
                }
            };
        });

        function confirmBlock(event) {
            if (!confirm("Are you sure you want to block this users?")) {
                event.preventDefault();
            }
        }
        function confirmDelete(event) {
            if (!confirm("Are you sure you want to delete this users?")) {
                event.preventDefault();
            }
        }
        function confirmRemove(event) {
            if (!confirm("Are you sure you want to remove this as admin?")) {
                event.preventDefault();
            }
        }
    </script>


    <!--    <script>-->
<!--        document.addEventListener("DOMContentLoaded", function() {-->
<!--            function getCsrfToken() {-->
<!--                const tokenMeta = document.querySelector('meta[name="_csrf"]');-->
<!--                return tokenMeta ? tokenMeta.getAttribute('content') : '';-->
<!--            }-->

<!--            function getCsrfHeader() {-->
<!--                const headerMeta = document.querySelector('meta[name="_csrf_header"]');-->
<!--                return headerMeta ? headerMeta.getAttribute('content') : '';-->
<!--            }-->

<!--            function sendRequest(url, userIds, method) {-->
<!--                const csrfHeaderName = getCsrfHeader();-->
<!--                const csrfToken = getCsrfToken();-->

<!--                if (!csrfHeaderName || !csrfToken) {-->
<!--                    console.error('CSRF token or header name not found');-->
<!--                    return;-->
<!--                }-->

<!--                const headers = new Headers();-->
<!--                headers.append('Content-Type', 'application/json');-->
<!--                headers.append(csrfHeaderName, csrfToken);-->

<!--                fetch(url, {-->
<!--                    method: method,-->
<!--                    headers: headers,-->
<!--                    body: JSON.stringify(userIds)-->
<!--                })-->
<!--                    .then(response => {-->
<!--                        if (!response.ok) {-->
<!--                            throw new Error('Network response was not ok: ' + response.statusText);-->
<!--                        }-->
<!--                        return response.text();-->
<!--                    })-->
<!--                    .then(data => {-->
<!--                        alert(data);-->
<!--                        // Redirect to logout URL-->
<!--                        window.location.href = "/logout";-->
<!--                    })-->
<!--                    .catch(error => console.error('Error:', error));-->
<!--            }-->

<!--            function getSelectedUserIds() {-->
<!--                var checkboxes = document.querySelectorAll('.selectRow:checked');-->
<!--                var userIds = [];-->
<!--                for (var checkbox of checkboxes) {-->
<!--                    var row = checkbox.closest('tr');-->
<!--                    userIds.push(row.cells[1].innerText.trim()); // Ensure whitespace is trimmed-->
<!--                }-->
<!--                return userIds;-->
<!--            }-->

<!--            document.getElementById('blockBtn').onclick = function() {-->
<!--                var userIds = getSelectedUserIds();-->
<!--                if (userIds.length > 0) {-->
<!--                    sendRequest('/admin/block', userIds, 'POST');-->
<!--                } else {-->
<!--                    alert('No users selected');-->
<!--                }-->
<!--            };-->

<!--            document.getElementById('unblockBtn').onclick = function() {-->
<!--                var userIds = getSelectedUserIds();-->
<!--                if (userIds.length > 0) {-->
<!--                    sendRequest('/admin/unblock', userIds, 'POST');-->
<!--                } else {-->
<!--                    alert('No users selected');-->
<!--                }-->
<!--            };-->

<!--            document.getElementById('deleteBtn').onclick = function() {-->
<!--                var userIds = getSelectedUserIds();-->
<!--                if (userIds.length > 0) {-->
<!--                    sendRequest('/admin/delete', userIds, 'POST');-->
<!--                } else {-->
<!--                    alert('No users selected');-->
<!--                }-->
<!--            };-->

<!--            document.getElementById('makeAdminBtn').onclick = function() {-->
<!--                var userIds = getSelectedUserIds();-->
<!--                if (userIds.length > 0) {-->
<!--                    sendRequest('/admin/make_admin', userIds, 'POST');-->
<!--                } else {-->
<!--                    alert('No users selected');-->
<!--                }-->
<!--            };-->

<!--            document.getElementById('removeAdminBtn').onclick = function() {-->
<!--                var userIds = getSelectedUserIds();-->
<!--                if (userIds.length > 0) {-->
<!--                    sendRequest('/admin/remove_admin', userIds, 'POST');-->
<!--                } else {-->
<!--                    alert('No users selected');-->
<!--                }-->
<!--            };-->

<!--            document.getElementById('selectAll').onclick = function() {-->
<!--                var checkboxes = document.querySelectorAll('.selectRow');-->
<!--                for (var checkbox of checkboxes) {-->
<!--                    checkbox.checked = this.checked;-->
<!--                }-->
<!--            }-->

<!--            function confirmDelete(event) {-->
<!--                if (!confirm("Are you sure you want to delete these users?")) {-->
<!--                    event.preventDefault();-->
<!--                }-->
<!--            }-->
<!--        });-->
<!--    </script>-->


</section>
</body>
</html>